<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DoorLog">
    <meta name="theme-color" content="#1a1a1a">
    <title>DoorLog - Field Estimating</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f4f8;
            --bg-tertiary: #e2e8f0;
            --bg-elevated: #dbeafe;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --border: #cbd5e1;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .hidden { display: none !important; }
        
        /* Header */
        .header {
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            background: var(--accent);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .back-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: #ffffff;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ffffff;
        }
        
        .header-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        
        .header-action {
            padding: 10px 16px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: #ffffff;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: #ffffff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
        }
        
        .logo-text span { color: #ffffff; }
        
        .sync-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #ffffff;
            padding: 6px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #86efac;
        }
        
        /* Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 120px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-text {
            color: var(--text-secondary);
        }
        
        /* Cards */
        .job-card, .door-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .job-card:active, .door-card:active {
            border-color: var(--accent);
            background: var(--bg-elevated);
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .job-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .job-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .badge {
            font-size: 13px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .door-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-radius: 14px;
        }
        
        .door-id {
            font-family: monospace;
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            background: var(--accent);
            padding: 6px 10px;
            border-radius: 8px;
        }
        
        .door-info { flex: 1; min-width: 0; }
        
        .door-label {
            font-size: 15px;
            font-weight: 500;
        }
        
        .door-notes-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Bottom Action */
        .bottom-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            padding-bottom: calc(var(--safe-bottom) + 16px);
            background: linear-gradient(to top, #ffffff 60%, transparent);
        }
        
        .big-btn {
            width: 100%;
            padding: 18px;
            border: none;
            background: var(--accent);
            color: #ffffff;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .big-btn:active {
            background: var(--accent-hover);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 16px;
            z-index: 100;
        }
        
        .modal {
            background: #ffffff;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .modal-body { padding: 20px; }
        
        .modal-actions {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            border-top: 1px solid var(--border);
        }
        
        .modal-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-confirm {
            background: var(--accent);
            color: #ffffff;
        }
        
        /* Form */
        .form-label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: none;
        }
        
        .form-group { margin-bottom: 16px; }
        
        /* Sections */
        .section {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .section:last-child { border-bottom: none; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .section-action {
            padding: 8px 14px;
            border: none;
            background: var(--accent);
            color: #ffffff;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Photos */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .photo-grid img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .photo-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px dashed var(--border);
            cursor: pointer;
        }
        
        /* Voice & Chips */
        .voice-btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: var(--accent);
            color: #ffffff;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .voice-btn.recording {
            background: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .chip {
            padding: 10px 14px;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .chip:active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }
        
        /* Camera */
        .camera-screen {
            background: #000;
            position: relative;
        }
        
        .camera-viewfinder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 180px;
        }
        
        .camera-viewfinder video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: calc(var(--safe-top) + 16px);
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .camera-badge {
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .zoom-display {
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .zoom-slider-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0,0,0,0.6);
            padding: 10px 16px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:active {
            background: rgba(255,255,255,0.4);
        }
        
        .zoom-slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            outline: none;
        }
        
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            padding-bottom: calc(var(--safe-bottom) + 20px);
            background: #1e293b;
        }
        
        .camera-thumbs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            min-height: 10px;
        }
        
        .camera-thumb {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #475569;
            flex-shrink: 0;
        }
        
        .camera-actions {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        
        .camera-side-btn {
            width: 60px;
            height: 60px;
            border: none;
            background: #475569;
            color: #ffffff;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }
        
        .shutter-btn {
            width: 80px;
            height: 80px;
            border: 4px solid var(--accent);
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }
        
        .shutter-btn::before {
            content: '';
            position: absolute;
            inset: 6px;
            background: var(--accent);
            border-radius: 50%;
        }
        
        .shutter-btn:active::before {
            transform: scale(0.9);
        }
        
        .done-btn {
            padding: 14px 28px;
            border: none;
            background: var(--success);
            color: #fff;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Photo Viewer */
        .photo-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        
        .photo-viewer-header {
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .photo-viewer-close {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }
        
        .photo-viewer-delete {
            padding: 10px 16px;
            border: none;
            background: var(--danger);
            color: #fff;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .photo-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .photo-viewer-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 300;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast.success { background: var(--success); color: #fff; }
        .toast.error { background: var(--danger); color: #fff; }
    </style>
</head>
<body>

<!-- Job List Screen -->
<div id="screen-jobs" class="screen">
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üö™</div>
            <div class="logo-text">Door<span>Log</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
            <div class="sync-badge">
                <div class="sync-dot"></div>
                <span id="sync-status">Ready</span>
            </div>
            <button class="header-action" onclick="showSettings()" style="padding:10px 12px;">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="content" id="job-list"></div>
    <div class="bottom-action">
        <button class="big-btn" onclick="showNewJobModal()">Ôºã New Job</button>
    </div>
</div>

<!-- Job Detail Screen -->
<div id="screen-job" class="screen hidden">
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="showScreen('jobs')">‚Üê</button>
            <div>
                <div class="header-title" id="job-title"></div>
                <div class="header-subtitle" id="job-door-count"></div>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="header-action" onclick="deleteJob()">üóë</button>
            <button class="header-action" onclick="exportJob()">Export</button>
        </div>
    </div>
    <div class="content" id="door-list"></div>
    <div class="bottom-action">
        <button class="big-btn" onclick="addDoor()">Ôºã Add Door</button>
    </div>
</div>

<!-- Camera Screen -->
<div id="screen-camera" class="screen camera-screen hidden">
    <div class="camera-viewfinder">
        <video id="camera-video" autoplay playsinline muted></video>
        <div class="camera-overlay">
            <div class="camera-badge" id="camera-door-id"></div>
            <div class="zoom-display" id="zoom-display">1.0x</div>
        </div>
        <div class="zoom-slider-container">
            <button class="zoom-btn" onclick="adjustZoom(-0.5)">‚àí</button>
            <input type="range" id="zoom-slider" class="zoom-slider" min="1" max="5" step="0.1" value="1" oninput="setZoom(this.value)">
            <button class="zoom-btn" onclick="adjustZoom(0.5)">+</button>
        </div>
    </div>
    <div class="camera-controls">
        <div class="camera-thumbs" id="camera-thumbs"></div>
        <div class="camera-actions">
            <button class="camera-side-btn" onclick="closeCamera()">‚úï</button>
            <button class="shutter-btn" onclick="capturePhoto()"></button>
            <button class="done-btn" onclick="cameraDone()">Done</button>
        </div>
    </div>
    <canvas id="camera-canvas" style="display:none;"></canvas>
</div>

<!-- Door Detail Screen -->
<div id="screen-door" class="screen hidden">
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="showScreen('job')">‚Üê</button>
            <div>
                <div class="header-title" id="door-title" style="font-family:monospace;"></div>
                <div class="header-subtitle" id="door-subtitle"></div>
            </div>
        </div>
        <button class="header-action" onclick="deleteDoor()">üóë</button>
    </div>
    <div class="content">
        <div class="section">
            <div class="section-header">
                <span class="section-title">Door Label</span>
            </div>
            <input type="text" class="form-input" id="door-label-input" placeholder="e.g., Front Entry, Suite 201..." oninput="updateDoorLabel(this.value)">
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">Photos (<span id="photo-count">0</span>)</span>
                <button class="section-action" onclick="openCameraForDoor()">üì∑ Add</button>
            </div>
            <div id="photo-grid"></div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">Notes</span>
            </div>
            <textarea class="form-textarea" id="door-notes" placeholder="Type notes here..." oninput="updateDoorNotes(this.value)"></textarea>
            <button class="voice-btn" id="voice-btn" onclick="toggleVoice()">üé§ Voice Input</button>
            <div class="chips" id="chips"></div>
        </div>
    </div>
</div>

<!-- New Job Modal -->
<div id="modal-new-job" class="modal-overlay hidden" onclick="hideNewJobModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">New Job</div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Job Name / Address</label>
                <input type="text" class="form-input" id="new-job-name" placeholder="e.g., 450 Main Street">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="hideNewJobModal()">Cancel</button>
            <button class="btn-confirm" onclick="createJob()">Create Job</button>
        </div>
    </div>
</div>

<!-- Photo Viewer -->
<div id="photo-viewer" class="photo-viewer hidden">
    <div class="photo-viewer-header">
        <button class="photo-viewer-close" onclick="closePhotoViewer()">‚úï</button>
        <button class="photo-viewer-delete" onclick="deleteCurrentPhoto()">Delete</button>
    </div>
    <div class="photo-viewer-content">
        <img id="photo-viewer-img" src="">
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<!-- Settings Screen -->
<div id="screen-settings" class="screen hidden">
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="showScreen('jobs')">‚Üê</button>
            <div>
                <div class="header-title">Settings</div>
                <div class="header-subtitle">Quick Phrases & Options</div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="section">
            <div class="section-header">
                <span class="section-title">Quick Phrases</span>
            </div>
            <p style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">Tap a phrase to delete it. Add new phrases below.</p>
            <div id="settings-chips" class="chips" style="margin-bottom:16px;"></div>
            <div style="display:flex;gap:8px;">
                <input type="text" class="form-input" id="new-chip-input" placeholder="Add new phrase..." style="flex:1;">
                <button class="big-btn" onclick="addNewChip()" style="width:auto;padding:14px 20px;">Add</button>
            </div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">Reset Phrases</span>
            </div>
            <button class="voice-btn" onclick="resetChipsToDefault()" style="background:var(--danger);">Reset to Defaults</button>
        </div>
    </div>
</div>

<script>
// ============ DATABASE ============
var DB_NAME = 'DoorLogDB';
var DB_VERSION = 1;
var db = null;

function initDB() {
    return new Promise(function(resolve, reject) {
        var request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = function() { reject(request.error); };
        request.onsuccess = function() {
            db = request.result;
            resolve(db);
        };
        
        request.onupgradeneeded = function(e) {
            var database = e.target.result;
            if (!database.objectStoreNames.contains('jobs')) {
                database.createObjectStore('jobs', { keyPath: 'id' });
            }
            if (!database.objectStoreNames.contains('doors')) {
                var doorStore = database.createObjectStore('doors', { keyPath: 'id' });
                doorStore.createIndex('jobId', 'jobId');
            }
            if (!database.objectStoreNames.contains('photos')) {
                var photoStore = database.createObjectStore('photos', { keyPath: 'id' });
                photoStore.createIndex('doorId', 'doorId');
            }
        };
    });
}

function dbGet(store, key) {
    return new Promise(function(resolve, reject) {
        var tx = db.transaction(store, 'readonly');
        var request = tx.objectStore(store).get(key);
        request.onsuccess = function() { resolve(request.result); };
        request.onerror = function() { reject(request.error); };
    });
}

function dbGetAll(store) {
    return new Promise(function(resolve, reject) {
        var tx = db.transaction(store, 'readonly');
        var request = tx.objectStore(store).getAll();
        request.onsuccess = function() { resolve(request.result); };
        request.onerror = function() { reject(request.error); };
    });
}

function dbGetByIndex(store, indexName, value) {
    return new Promise(function(resolve, reject) {
        var tx = db.transaction(store, 'readonly');
        var index = tx.objectStore(store).index(indexName);
        var request = index.getAll(value);
        request.onsuccess = function() { resolve(request.result); };
        request.onerror = function() { reject(request.error); };
    });
}

function dbPut(store, item) {
    return new Promise(function(resolve, reject) {
        var tx = db.transaction(store, 'readwrite');
        var request = tx.objectStore(store).put(item);
        request.onsuccess = function() { resolve(request.result); };
        request.onerror = function() { reject(request.error); };
    });
}

function dbDelete(store, key) {
    return new Promise(function(resolve, reject) {
        var tx = db.transaction(store, 'readwrite');
        var request = tx.objectStore(store).delete(key);
        request.onsuccess = function() { resolve(); };
        request.onerror = function() { reject(request.error); };
    });
}

// ============ STATE ============
var currentJob = null;
var currentDoor = null;
var currentPhotos = [];
var viewingPhotoId = null;
var cameraStream = null;
var cameraTrack = null;
var currentZoom = 1;
var minZoom = 1;
var maxZoom = 5;
var isRecording = false;
var recognition = null;

var defaultChips = ['Needs rekey', 'Replace hardware', 'ADA issue', 'Fire-rated', 'Good condition', 'Mortise lock', 'Cylindrical', 'Panic hardware'];
var quickChips = [];

function loadChips() {
    var saved = localStorage.getItem('doorlog_chips');
    if (saved) {
        try {
            quickChips = JSON.parse(saved);
        } catch(e) {
            quickChips = defaultChips.slice();
        }
    } else {
        quickChips = defaultChips.slice();
    }
}

function saveChips() {
    localStorage.setItem('doorlog_chips', JSON.stringify(quickChips));
}

// ============ HELPERS ============
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function generateJobCode(name) {
    var match = name.match(/\d+/);
    if (match) return match[0].slice(0, 4);
    return name.replace(/[^a-zA-Z]/g, '').slice(0, 4).toUpperCase();
}

function formatDate(dateStr) {
    var d = new Date(dateStr);
    var now = new Date();
    if (d.toDateString() === now.toDateString()) return 'Today';
    var yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function showToast(message, type) {
    var toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + (type || '');
    setTimeout(function() { toast.classList.add('hidden'); }, 2500);
}

// ============ SCREENS ============
function showScreen(name) {
    var screens = document.querySelectorAll('.screen');
    for (var i = 0; i < screens.length; i++) {
        screens[i].classList.add('hidden');
    }
    document.getElementById('screen-' + name).classList.remove('hidden');
    
    if (name === 'jobs') loadJobs();
    if (name === 'job') loadDoors();
    if (name === 'door') loadDoorDetail();
    if (name === 'settings') renderSettingsChips();
}

// ============ JOBS ============
function loadJobs() {
    dbGetAll('jobs').then(function(jobs) {
        jobs.sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });
        
        var container = document.getElementById('job-list');
        
        if (jobs.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No Jobs Yet</div><div class="empty-text">Tap the button below to start your first job walk.</div></div>';
            return;
        }
        
        var html = '';
        for (var i = 0; i < jobs.length; i++) {
            var job = jobs[i];
            html += '<div class="job-card" onclick="openJob(\'' + job.id + '\')"><div class="job-header"><div><div class="job-name">' + job.name + '</div><div class="job-meta">' + formatDate(job.createdAt) + '</div></div><div class="badge">' + (job.doorCount || 0) + ' doors</div></div></div>';
        }
        container.innerHTML = html;
    });
}

function showNewJobModal() {
    document.getElementById('modal-new-job').classList.remove('hidden');
    document.getElementById('new-job-name').value = '';
    document.getElementById('new-job-name').focus();
}

function hideNewJobModal() {
    document.getElementById('modal-new-job').classList.add('hidden');
}

function createJob() {
    var name = document.getElementById('new-job-name').value.trim();
    if (!name) return;
    
    var job = {
        id: generateId(),
        name: name,
        code: generateJobCode(name),
        doorCount: 0,
        createdAt: new Date().toISOString()
    };
    
    dbPut('jobs', job).then(function() {
        hideNewJobModal();
        currentJob = job;
        showScreen('job');
    });
}

function openJob(id) {
    dbGet('jobs', id).then(function(job) {
        currentJob = job;
        showScreen('job');
    });
}

// ============ DOORS ============
function loadDoors() {
    document.getElementById('job-title').textContent = currentJob.name;
    
    dbGetByIndex('doors', 'jobId', currentJob.id).then(function(doors) {
        doors.sort(function(a, b) { return a.sequence - b.sequence; });
        
        document.getElementById('job-door-count').textContent = doors.length + ' doors';
        
        var container = document.getElementById('door-list');
        
        if (doors.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">üö™</div><div class="empty-title">No Doors Yet</div><div class="empty-text">Tap below to add your first door. Camera opens automatically.</div></div>';
            return;
        }
        
        var html = '';
        for (var i = 0; i < doors.length; i++) {
            var door = doors[i];
            var notesPreview = door.notes ? '<div class="door-notes-preview">' + door.notes.slice(0, 40) + '...</div>' : '';
            html += '<div class="door-card" onclick="openDoor(\'' + door.id + '\')"><div class="door-id">' + door.doorId + '</div><div class="door-info"><div class="door-label">' + (door.label || 'No label') + '</div>' + notesPreview + '</div><div class="badge">üì∑ ' + (door.photoCount || 0) + '</div></div>';
        }
        container.innerHTML = html;
    });
}

function addDoor() {
    dbGetByIndex('doors', 'jobId', currentJob.id).then(function(doors) {
        var sequence = doors.length + 1;
        var doorId = currentJob.code + '-D' + ('0' + sequence).slice(-2);
        
        var door = {
            id: generateId(),
            jobId: currentJob.id,
            doorId: doorId,
            sequence: sequence,
            label: '',
            notes: '',
            photoCount: 0,
            createdAt: new Date().toISOString()
        };
        
        dbPut('doors', door).then(function() {
            currentJob.doorCount = sequence;
            return dbPut('jobs', currentJob);
        }).then(function() {
            currentDoor = door;
            openCamera();
        });
    });
}

function openDoor(id) {
    dbGet('doors', id).then(function(door) {
        currentDoor = door;
        showScreen('door');
    });
}

function loadDoorDetail() {
    document.getElementById('door-title').textContent = currentDoor.doorId;
    document.getElementById('door-subtitle').textContent = currentDoor.label || 'No label';
    document.getElementById('door-label-input').value = currentDoor.label || '';
    document.getElementById('door-notes').value = currentDoor.notes || '';
    
    dbGetByIndex('photos', 'doorId', currentDoor.id).then(function(photos) {
        photos.sort(function(a, b) { return a.sequence - b.sequence; });
        currentPhotos = photos;
        renderPhotos();
    });
    
    var chipsHtml = '';
    for (var i = 0; i < quickChips.length; i++) {
        chipsHtml += '<button class="chip" onclick="addChip(\'' + quickChips[i] + '\')">' + quickChips[i] + '</button>';
    }
    document.getElementById('chips').innerHTML = chipsHtml;
}

function renderPhotos() {
    document.getElementById('photo-count').textContent = currentPhotos.length;
    var grid = document.getElementById('photo-grid');
    
    if (currentPhotos.length === 0) {
        grid.innerHTML = '<div class="photo-empty" onclick="openCameraForDoor()">Tap to take photos</div>';
    } else {
        var html = '<div class="photo-grid">';
        for (var i = 0; i < currentPhotos.length; i++) {
            html += '<img src="' + currentPhotos[i].dataUrl + '" onclick="viewPhoto(\'' + currentPhotos[i].id + '\')">';
        }
        html += '</div>';
        grid.innerHTML = html;
    }
}

function updateDoorLabel(value) {
    currentDoor.label = value;
    document.getElementById('door-subtitle').textContent = value || 'No label';
    dbPut('doors', currentDoor);
}

function updateDoorNotes(value) {
    currentDoor.notes = value;
    dbPut('doors', currentDoor);
}

function addChip(text) {
    var textarea = document.getElementById('door-notes');
    var current = textarea.value;
    var separator = current.length > 0 ? '. ' : '';
    textarea.value = current + separator + text;
    updateDoorNotes(textarea.value);
}

function deleteDoor() {
    var confirmDelete = confirm('Delete ' + currentDoor.doorId + '? This cannot be undone.');
    if (!confirmDelete) return;
    
    // Delete all photos first
    var deletePhotos = Promise.resolve();
    
    if (currentPhotos && currentPhotos.length > 0) {
        var photoDeletes = [];
        for (var i = 0; i < currentPhotos.length; i++) {
            photoDeletes.push(dbDelete('photos', currentPhotos[i].id));
        }
        deletePhotos = Promise.all(photoDeletes);
    }
    
    deletePhotos.then(function() {
        // Delete the door
        return dbDelete('doors', currentDoor.id);
    }).then(function() {
        // Update job door count
        return dbGetByIndex('doors', 'jobId', currentJob.id);
    }).then(function(remainingDoors) {
        currentJob.doorCount = remainingDoors.length;
        return dbPut('jobs', currentJob);
    }).then(function() {
        showToast('Door deleted', 'success');
        showScreen('job');
    }).catch(function(err) {
        console.error('Delete error:', err);
        showToast('Delete failed', 'error');
    });
}

// ============ CAMERA ============
function openCamera() {
    showScreen('camera');
    document.getElementById('camera-door-id').textContent = currentDoor.doorId;
    document.getElementById('camera-thumbs').innerHTML = '';
    
    // Reset zoom
    currentZoom = 1;
    document.getElementById('zoom-slider').value = 1;
    document.getElementById('zoom-display').textContent = '1.0x';
    
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
    }).then(function(stream) {
        cameraStream = stream;
        cameraTrack = stream.getVideoTracks()[0];
        document.getElementById('camera-video').srcObject = stream;
        
        // Check for zoom capabilities
        var capabilities = cameraTrack.getCapabilities();
        if (capabilities.zoom) {
            minZoom = capabilities.zoom.min || 1;
            maxZoom = capabilities.zoom.max || 5;
            
            // Update slider range
            var slider = document.getElementById('zoom-slider');
            slider.min = minZoom;
            slider.max = Math.min(maxZoom, 10); // Cap at 10x for usability
            slider.value = minZoom;
            currentZoom = minZoom;
            
            document.getElementById('zoom-display').textContent = currentZoom.toFixed(1) + 'x';
        }
    }).catch(function(err) {
        console.error('Camera error:', err);
        showToast('Could not access camera', 'error');
        showScreen('door');
    });
}

function setZoom(value) {
    currentZoom = parseFloat(value);
    document.getElementById('zoom-display').textContent = currentZoom.toFixed(1) + 'x';
    document.getElementById('zoom-slider').value = currentZoom;
    
    if (cameraTrack) {
        var capabilities = cameraTrack.getCapabilities();
        if (capabilities.zoom) {
            cameraTrack.applyConstraints({
                advanced: [{ zoom: currentZoom }]
            }).catch(function(err) {
                console.error('Zoom error:', err);
            });
        }
    }
}

function adjustZoom(delta) {
    var newZoom = currentZoom + delta;
    newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
    setZoom(newZoom);
}

function openCameraForDoor() {
    openCamera();
}

function closeCamera() {
    stopCamera();
    showScreen('door');
}

function stopCamera() {
    if (cameraStream) {
        var tracks = cameraStream.getTracks();
        for (var i = 0; i < tracks.length; i++) {
            tracks[i].stop();
        }
        cameraStream = null;
        cameraTrack = null;
    }
}

function capturePhoto() {
    var video = document.getElementById('camera-video');
    var canvas = document.getElementById('camera-canvas');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    var ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Watermark
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(10, canvas.height - 40, 150, 30);
    ctx.fillStyle = '#2563eb';
    ctx.font = 'bold 18px monospace';
    ctx.fillText(currentDoor.doorId, 20, canvas.height - 18);
    
    var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
    
    dbGetByIndex('photos', 'doorId', currentDoor.id).then(function(photos) {
        var sequence = photos.length + 1;
        
        var photo = {
            id: generateId(),
            doorId: currentDoor.id,
            doorCode: currentDoor.doorId,
            filename: currentDoor.doorId + '_' + ('0' + sequence).slice(-2) + '.jpg',
            sequence: sequence,
            dataUrl: dataUrl,
            capturedAt: new Date().toISOString()
        };
        
        return dbPut('photos', photo).then(function() {
            currentDoor.photoCount = sequence;
            return dbPut('doors', currentDoor);
        }).then(function() {
            var thumbs = document.getElementById('camera-thumbs');
            thumbs.innerHTML += '<img src="' + dataUrl + '" class="camera-thumb">';
            
            if (navigator.vibrate) navigator.vibrate(50);
        });
    });
}

function cameraDone() {
    stopCamera();
    showScreen('door');
}

// ============ PHOTO VIEWER ============
function viewPhoto(id) {
    viewingPhotoId = id;
    var photo = null;
    for (var i = 0; i < currentPhotos.length; i++) {
        if (currentPhotos[i].id === id) {
            photo = currentPhotos[i];
            break;
        }
    }
    document.getElementById('photo-viewer-img').src = photo.dataUrl;
    document.getElementById('photo-viewer').classList.remove('hidden');
}

function closePhotoViewer() {
    document.getElementById('photo-viewer').classList.add('hidden');
    viewingPhotoId = null;
}

function deleteCurrentPhoto() {
    dbDelete('photos', viewingPhotoId).then(function() {
        currentPhotos = currentPhotos.filter(function(p) { return p.id !== viewingPhotoId; });
        currentDoor.photoCount = currentPhotos.length;
        return dbPut('doors', currentDoor);
    }).then(function() {
        closePhotoViewer();
        renderPhotos();
        showToast('Photo deleted', 'success');
    });
}

// ============ VOICE ============
function toggleVoice() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice input not supported', 'error');
        return;
    }
    
    if (isRecording) {
        recognition.stop();
        return;
    }
    
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    
    var textarea = document.getElementById('door-notes');
    var baseText = textarea.value;
    
    recognition.onresult = function(e) {
        var transcript = '';
        for (var i = e.resultIndex; i < e.results.length; i++) {
            transcript += e.results[i][0].transcript;
        }
        var separator = baseText.length > 0 && !baseText.endsWith(' ') ? ' ' : '';
        textarea.value = baseText + separator + transcript;
    };
    
    recognition.onend = function() {
        isRecording = false;
        document.getElementById('voice-btn').classList.remove('recording');
        document.getElementById('voice-btn').textContent = 'üé§ Voice Input';
        updateDoorNotes(textarea.value);
    };
    
    recognition.onerror = function() {
        isRecording = false;
        document.getElementById('voice-btn').classList.remove('recording');
        document.getElementById('voice-btn').textContent = 'üé§ Voice Input';
    };
    
    recognition.start();
    isRecording = true;
    document.getElementById('voice-btn').classList.add('recording');
    document.getElementById('voice-btn').textContent = '‚èπ Stop Recording';
}

// ============ EXPORT ============
function exportJob() {
    showToast('Preparing export...', '');
    
    dbGetByIndex('doors', 'jobId', currentJob.id).then(function(doors) {
        doors.sort(function(a, b) { return a.sequence - b.sequence; });
        
        var zip = new JSZip();
        var photosFolder = zip.folder('Photos');
        
        var csv = 'Door ID,Label,Photo Count,Photo Folder,Notes,Timestamp\n';
        
        var photoPromises = [];
        
        for (var i = 0; i < doors.length; i++) {
            (function(door) {
                var promise = dbGetByIndex('photos', 'doorId', door.id).then(function(photos) {
                    photos.sort(function(a, b) { return a.sequence - b.sequence; });
                    
                    var folderName = door.label 
                        ? door.doorId + '_' + door.label.replace(/[^a-zA-Z0-9]/g, '-')
                        : door.doorId;
                    
                    if (photos.length > 0) {
                        var doorFolder = photosFolder.folder(folderName);
                        for (var j = 0; j < photos.length; j++) {
                            var photo = photos[j];
                            // Extract base64 data (remove data:image/jpeg;base64, prefix)
                            var base64Data = photo.dataUrl.split(',')[1];
                            doorFolder.file(photo.filename, base64Data, { base64: true });
                        }
                    }
                    
                    var notes = (door.notes || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    return '"' + door.doorId + '","' + (door.label || '') + '",' + photos.length + ',"Photos/' + folderName + '","' + notes + '","' + door.createdAt + '"';
                });
                photoPromises.push(promise);
            })(doors[i]);
        }
        
        return Promise.all(photoPromises).then(function(csvRows) {
            csv += csvRows.join('\n');
            zip.file('DoorLog_' + currentJob.name.replace(/[^a-zA-Z0-9]/g, '-') + '.csv', csv);
            
            return zip.generateAsync({ type: 'blob' });
        });
    }).then(function(blob) {
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = currentJob.name.replace(/[^a-zA-Z0-9]/g, '-') + '_' + new Date().toISOString().slice(0, 10) + '.zip';
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Export complete with photos!', 'success');
    }).catch(function(err) {
        console.error('Export error:', err);
        showToast('Export failed', 'error');
    });
}

// ============ DELETE JOB ============
function deleteJob() {
    var confirmDelete = confirm('Delete "' + currentJob.name + '" and ALL its doors and photos? This cannot be undone.');
    if (!confirmDelete) return;
    
    showToast('Deleting job...', '');
    
    // Get all doors for this job
    dbGetByIndex('doors', 'jobId', currentJob.id).then(function(doors) {
        var deletePromises = [];
        
        // For each door, delete all its photos
        for (var i = 0; i < doors.length; i++) {
            (function(door) {
                var promise = dbGetByIndex('photos', 'doorId', door.id).then(function(photos) {
                    var photoDeletes = [];
                    for (var j = 0; j < photos.length; j++) {
                        photoDeletes.push(dbDelete('photos', photos[j].id));
                    }
                    return Promise.all(photoDeletes);
                }).then(function() {
                    return dbDelete('doors', door.id);
                });
                deletePromises.push(promise);
            })(doors[i]);
        }
        
        return Promise.all(deletePromises);
    }).then(function() {
        // Delete the job itself
        return dbDelete('jobs', currentJob.id);
    }).then(function() {
        currentJob = null;
        showToast('Job deleted', 'success');
        showScreen('jobs');
    }).catch(function(err) {
        console.error('Delete job error:', err);
        showToast('Delete failed', 'error');
    });
}

// ============ SETTINGS ============
function showSettings() {
    document.querySelectorAll('.screen').forEach(function(s) { s.classList.add('hidden'); });
    document.getElementById('screen-settings').classList.remove('hidden');
    renderSettingsChips();
}

function renderSettingsChips() {
    var container = document.getElementById('settings-chips');
    var html = '';
    for (var i = 0; i < quickChips.length; i++) {
        html += '<button class="chip" onclick="deleteChip(' + i + ')" style="position:relative;">' + quickChips[i] + ' <span style="color:var(--danger);margin-left:4px;">‚úï</span></button>';
    }
    container.innerHTML = html;
}

function deleteChip(index) {
    var confirmDelete = confirm('Delete "' + quickChips[index] + '"?');
    if (!confirmDelete) return;
    
    quickChips.splice(index, 1);
    saveChips();
    renderSettingsChips();
    showToast('Phrase deleted', 'success');
}

function addNewChip() {
    var input = document.getElementById('new-chip-input');
    var value = input.value.trim();
    
    if (!value) {
        showToast('Enter a phrase first', 'error');
        return;
    }
    
    // Check for duplicates
    for (var i = 0; i < quickChips.length; i++) {
        if (quickChips[i].toLowerCase() === value.toLowerCase()) {
            showToast('Phrase already exists', 'error');
            return;
        }
    }
    
    quickChips.push(value);
    saveChips();
    input.value = '';
    renderSettingsChips();
    showToast('Phrase added', 'success');
}

function resetChipsToDefault() {
    var confirmReset = confirm('Reset all phrases to defaults? Your custom phrases will be lost.');
    if (!confirmReset) return;
    
    quickChips = defaultChips.slice();
    saveChips();
    renderSettingsChips();
    showToast('Phrases reset to defaults', 'success');
}

// ============ INIT ============
loadChips();
initDB().then(function() {
    showScreen('jobs');
}).catch(function(err) {
    console.error('DB init failed:', err);
    document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#333;">Failed to initialize database. Please refresh.</div>';
});
</script>

</body>
</html>

import React, { useState, useEffect } from 'react';
import { Lock, Plus, Search, Key, User, Settings, LogOut, Eye, EyeOff, Save, X } from 'lucide-react';

const encrypt = (text, password) => {
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify({ data: text, key: password }))));
  return encoded;
};

const decrypt = (encoded, password) => {
  try {
    const decoded = JSON.parse(decodeURIComponent(escape(atob(encoded))));
    if (decoded.key === password) {
      return decoded.data;
    }
    return null;
  } catch {
    return null;
  }
};

export default function LocksmithApp() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [hasPassword, setHasPassword] = useState(false);
  const [loginError, setLoginError] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [currentPassword, setCurrentPassword] = useState('');
  
  const [customers, setCustomers] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [currentView, setCurrentView] = useState('list');
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [editingCustomer, setEditingCustomer] = useState(null);
  const [confirmDialog, setConfirmDialog] = useState(null);
  const [expandedJob, setExpandedJob] = useState(null);
  const [customerView, setCustomerView] = useState('jobs');
  const [keyFilter, setKeyFilter] = useState({ keyType: 'all', search: '' });
  const [keySortBy, setKeySortBy] = useState('keyway');
  
  const [lastActivity, setLastActivity] = useState(Date.now());
  const [lockTimeout] = useState(5 * 60 * 1000);

  useEffect(() => {
    const stored = localStorage.getItem('locksmith_password');
    setHasPassword(!!stored);
  }, []);

  useEffect(() => {
    if (!isAuthenticated) return;

    const checkActivity = setInterval(() => {
      if (Date.now() - lastActivity > lockTimeout) {
        handleLogout();
      }
    }, 10000);

    const resetActivity = () => setLastActivity(Date.now());
    window.addEventListener('click', resetActivity);
    window.addEventListener('keypress', resetActivity);
    window.addEventListener('touchstart', resetActivity);

    return () => {
      clearInterval(checkActivity);
      window.removeEventListener('click', resetActivity);
      window.removeEventListener('keypress', resetActivity);
      window.removeEventListener('touchstart', resetActivity);
    };
  }, [isAuthenticated, lastActivity, lockTimeout]);

  useEffect(() => {
    if (isAuthenticated && currentPassword) {
      loadCustomers();
    }
  }, [isAuthenticated, currentPassword]);

  const loadCustomers = () => {
    const stored = localStorage.getItem('locksmith_customers');
    if (stored) {
      const decrypted = decrypt(stored, currentPassword);
      if (decrypted) {
        setCustomers(JSON.parse(decrypted));
      }
    }
  };

  const saveCustomers = (newCustomers) => {
    const encrypted = encrypt(JSON.stringify(newCustomers), currentPassword);
    localStorage.setItem('locksmith_customers', encrypted);
    setCustomers(newCustomers);
  };

  const handleLogin = () => {
    if (!hasPassword) {
      if (password.length < 6) {
        setLoginError('Password must be at least 6 characters');
        return;
      }
      localStorage.setItem('locksmith_password', encrypt('verified', password));
      setCurrentPassword(password);
      setIsAuthenticated(true);
      setPassword('');
    } else {
      const stored = localStorage.getItem('locksmith_password');
      const verified = decrypt(stored, password);
      
      if (verified === 'verified') {
        setCurrentPassword(password);
        setIsAuthenticated(true);
        setPassword('');
        setLoginError('');
      } else {
        setLoginError('Incorrect password');
      }
    }
  };

  const handleLogout = () => {
    setIsAuthenticated(false);
    setCurrentPassword('');
    setPassword('');
    setSelectedCustomer(null);
    setEditingCustomer(null);
    setCurrentView('list');
    setCustomerView('jobs');
    setExpandedJob(null);
  };

  const addCustomer = () => {
    setEditingCustomer({
      id: Date.now(),
      name: '',
      phone: '',
      address: '',
      notes: '',
      jobs: []
    });
    setCurrentView('edit');
  };

  const saveCustomer = () => {
    if (!editingCustomer.name.trim()) return;
    const updated = customers.filter(c => c.id !== editingCustomer.id);
    updated.push(editingCustomer);
    saveCustomers(updated);
    setEditingCustomer(null);
    setCurrentView('list');
  };

  const deleteCustomer = (id) => {
    setConfirmDialog({
      message: 'Delete this customer and all associated jobs? This cannot be undone.',
      onConfirm: () => {
        saveCustomers(customers.filter(c => c.id !== id));
        setSelectedCustomer(null);
        setCurrentView('list');
        setConfirmDialog(null);
      },
      onCancel: () => setConfirmDialog(null)
    });
  };

  const addJob = () => {
    if (!selectedCustomer) return;
    
    const newJob = {
      id: Date.now(),
      date: new Date().toISOString().split('T')[0],
      address: '',
      city: '',
      zip: '',
      notes: '',
      onsiteContact: '',
      onsitePhone: '',
      keys: []
    };

    const updated = customers.map(c => {
      if (c.id === selectedCustomer.id) {
        return { ...c, jobs: [...c.jobs, newJob] };
      }
      return c;
    });

    saveCustomers(updated);
    setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
  };

  const updateJob = (jobId, field, value) => {
    const updated = customers.map(c => {
      if (c.id === selectedCustomer.id) {
        return {
          ...c,
          jobs: c.jobs.map(j => j.id === jobId ? { ...j, [field]: value } : j)
        };
      }
      return c;
    });

    saveCustomers(updated);
    setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
  };

  const deleteJob = (jobId) => {
    setConfirmDialog({
      message: 'Delete this job? This cannot be undone.',
      onConfirm: () => {
        const updated = customers.map(c => {
          if (c.id === selectedCustomer.id) {
            return { ...c, jobs: c.jobs.filter(j => j.id !== jobId) };
          }
          return c;
        });
        saveCustomers(updated);
        const updatedCustomer = updated.find(c => c.id === selectedCustomer.id);
        setSelectedCustomer(updatedCustomer);
        setConfirmDialog(null);
      },
      onCancel: () => setConfirmDialog(null)
    });
  };

  const addKeyToJob = (jobId) => {
    const newKey = {
      id: Date.now() + Math.random(),
      keyType: 'Change Key',
      keyway: '',
      site: '',
      bitting: '',
      tag: '',
      quantity: 1,
      notes: ''
    };

    const updated = customers.map(c => {
      if (c.id === selectedCustomer.id) {
        return {
          ...c,
          jobs: c.jobs.map(j => {
            if (j.id === jobId) {
              return { ...j, keys: [...(j.keys || []), newKey] };
            }
            return j;
          })
        };
      }
      return c;
    });

    saveCustomers(updated);
    setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
  };

  const updateKey = (jobId, keyId, field, value) => {
    const updated = customers.map(c => {
      if (c.id === selectedCustomer.id) {
        return {
          ...c,
          jobs: c.jobs.map(j => {
            if (j.id === jobId) {
              return {
                ...j,
                keys: (j.keys || []).map(k => k.id === keyId ? { ...k, [field]: value } : k)
              };
            }
            return j;
          })
        };
      }
      return c;
    });

    saveCustomers(updated);
    setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
  };

  const deleteKey = (jobId, keyId) => {
    setConfirmDialog({
      message: 'Delete this key? This cannot be undone.',
      onConfirm: () => {
        const updated = customers.map(c => {
          if (c.id === selectedCustomer.id) {
            return {
              ...c,
              jobs: c.jobs.map(j => {
                if (j.id === jobId) {
                  return { ...j, keys: (j.keys || []).filter(k => k.id !== keyId) };
                }
                return j;
              })
            };
          }
          return c;
        });
        saveCustomers(updated);
        setSelectedCustomer(updated.find(c => c.id === selectedCustomer.id));
        setConfirmDialog(null);
      },
      onCancel: () => setConfirmDialog(null)
    });
  };

  const filteredCustomers = customers.filter(c =>
    c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    c.phone.includes(searchTerm) ||
    c.address.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const ConfirmDialog = () => (
    confirmDialog && (
      <div 
        className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
        onClick={(e) => {
          e.stopPropagation();
          e.preventDefault();
        }}
      >
        <div className="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl">
          <p className="text-gray-800 mb-6 text-base">{confirmDialog.message}</p>
          <div className="flex gap-3">
            <button
              onClick={(e) => {
                e.stopPropagation();
                e.preventDefault();
                confirmDialog.onCancel();
              }}
              className="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 active:bg-gray-400 text-base min-h-[44px]"
            >
              Cancel
            </button>
            <button
              onClick={(e) => {
                e.stopPropagation();
                e.preventDefault();
                confirmDialog.onConfirm();
              }}
              className="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 active:bg-red-800 text-base min-h-[44px]"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    )
  );

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
          <div className="flex justify-center mb-6">
            <div className="bg-blue-600 p-4 rounded-full">
              <Lock className="w-12 h-12 text-white" />
            </div>
          </div>
          
          <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">
            Locksmith Pro
          </h1>
          <p className="text-center text-gray-600 mb-6">
            {hasPassword ? 'Enter your password to continue' : 'Create a password to secure your data'}
          </p>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <div className="relative">
              <input
                type={showPassword ? 'text' : 'password'}
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={hasPassword ? 'Enter password' : 'Create password (min 6 characters)'}
                autoFocus
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute right-3 top-3.5 text-gray-500"
              >
                {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
              </button>
            </div>
          </div>

          {loginError && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
              {loginError}
            </div>
          )}

          <button
            onClick={handleLogin}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
          >
            {hasPassword ? 'Unlock' : 'Create Password & Continue'}
          </button>

          <p className="text-xs text-gray-500 text-center mt-6">
            All data is encrypted and stored locally on your device
          </p>
        </div>
      </div>
    );
  }

  // Rest of the app continues...
  return <div className="min-h-screen bg-gray-50">Working app loaded!</div>;
}
